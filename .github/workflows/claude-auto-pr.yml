name: Claude Auto PR

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  claude-auto-pr:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude-pr')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude-pr'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Extract request from comment
        id: extract_request
        run: |
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT_BODY="${{ github.event.comment.body }}"
          else
            COMMENT_BODY="${{ github.event.comment.body }}"
          fi
          
          # Extract text after @claude-pr
          REQUEST=$(echo "$COMMENT_BODY" | sed -n 's/.*@claude-pr \(.*\)/\1/p')
          echo "request=$REQUEST" >> $GITHUB_OUTPUT
          
          # Generate branch name
          BRANCH_NAME="claude-auto-$(date +%s)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Create feature branch
        run: |
          git config --global user.name "Claude Bot"
          git config --global user.email "claude@anthropic.com"
          git checkout -b ${{ steps.extract_request.outputs.branch_name }}

      - name: Run Claude Code improvements
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          timeout_minutes: "30"
          context: |
            ìš”ì²­ì‚¬í•­: ${{ steps.extract_request.outputs.request }}
            
            ë‹¤ìŒ ê°œì„ ì‚¬í•­ì„ ì½”ë“œì— ì§ì ‘ ì ìš©í•´ì£¼ì„¸ìš”:
            1. ë³´ì•ˆ ì·¨ì•½ì  ìˆ˜ì • (DB ì„¤ì • í™˜ê²½ë³€ìˆ˜í™”)
            2. ì…ë ¥ ê²€ì¦ ê°•í™” (@Valid ì¶”ê°€)
            3. ì˜ˆì™¸ ì²˜ë¦¬ ì²´ê³„í™” (GlobalExceptionHandler)
            4. API ì—”ë“œí¬ì¸íŠ¸ ë¶ˆì¼ì¹˜ ìˆ˜ì •
            
            ë³€ê²½ì‚¬í•­ì„ íŒŒì¼ì— ì§ì ‘ ì ìš©í•˜ê³  ì»¤ë°‹í•´ì£¼ì„¸ìš”.

      - name: Push changes and create PR
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "ğŸ¤– Claude ìë™ ê°œì„ ì‚¬í•­ ì ìš©
            
            ìš”ì²­: ${{ steps.extract_request.outputs.request }}
            
            - ì½”ë“œ í’ˆì§ˆ ê°œì„ 
            - ë³´ì•ˆ ì·¨ì•½ì  ìˆ˜ì •
            - ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ ì ìš©
            
            ğŸ¤– Generated with Claude Code"
            
            git push origin ${{ steps.extract_request.outputs.branch_name }}
            
            # Create PR using GitHub CLI
            gh pr create \
              --title "ğŸ¤– Claude ìë™ ê°œì„ : ${{ steps.extract_request.outputs.request }}" \
              --body "## ğŸ¤– Claude ìë™ ê°œì„ ì‚¬í•­
              
              **ìš”ì²­ì‚¬í•­**: ${{ steps.extract_request.outputs.request }}
              
              ## ì ìš©ëœ ê°œì„ ì‚¬í•­
              - âœ… ë³´ì•ˆ ì·¨ì•½ì  ìˆ˜ì •
              - âœ… ì…ë ¥ ê²€ì¦ ê°•í™”  
              - âœ… ì˜ˆì™¸ ì²˜ë¦¬ ì²´ê³„í™”
              - âœ… API ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì •
              
              ## ê²€í†  ìš”ì²­
              ìë™ìœ¼ë¡œ ìƒì„±ëœ PRì…ë‹ˆë‹¤. ì½”ë“œ ë¦¬ë·° í›„ ë¨¸ì§€í•´ì£¼ì„¸ìš”.
              
              ğŸ¤– Generated with [Claude Code](https://claude.ai/code)" \
              --head ${{ steps.extract_request.outputs.branch_name }} \
              --base main
          else
            echo "No changes detected"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}